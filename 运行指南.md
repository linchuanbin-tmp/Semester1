# 项目运行指南

这是一个基于 Django + Vue 的多 LLM Agent 协作系统，采用前后端分离架构。

## 项目结构

- **后端**: Django 5.2.6 + Django REST Framework + Celery + Channels (WebSocket)
- **前端**: Vue 3 + TypeScript + Vite + Element Plus
- **数据库**: SQLite
- **消息队列**: Redis
- **异步任务**: Celery

## 前置要求

### 1. Python 环境
- Python 3.10+
- 建议使用虚拟环境 (venv)

### 2. Node.js 环境
- Node.js 16+ 和 npm

### 3. Redis
- Windows: 使用项目根目录下的 `Redis/redis-server.exe`
- Linux/Mac: 安装 Redis 5.0.14+

### 4. LM Studio (可选)
- 用于本地 LLM 服务
- 下载并安装最新版

## 安装步骤

### 第一步：安装 Python 依赖

```bash
# 进入项目目录
cd DjangoProject

# 创建虚拟环境（如果还没有）
python -m venv venv

# 激活虚拟环境
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# 安装依赖（根据 settings.py 中的配置）
pip install django==5.2.6
pip install djangorestframework
pip install celery==5.3.4
pip install channels
pip install channels-redis
pip install django-cors-headers
pip install openai==1.3.0
pip install redis
```

### 第二步：安装前端依赖

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install
```

### 第三步：初始化数据库

```bash
# 确保在 DjangoProject 目录下，且虚拟环境已激活
cd DjangoProject

# 生成迁移文件
python manage.py makemigrations

# 执行迁移
python manage.py migrate
```

## 运行步骤

需要同时运行多个服务，请打开多个终端窗口：

### 终端 1: 启动 Redis

**Windows:**
```bash
# 进入 Redis 目录
cd Redis
redis-server.exe
```

**Linux/Mac:**
```bash
redis-server
# 或使用 systemd/brew services 后台运行
```

### 终端 2: 启动 Celery Worker

```bash
# 进入项目根目录
cd DjangoProject

# 激活虚拟环境
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# 启动 Celery Worker
# Windows:
celery -A dagenthub worker -l info -Q celery --pool=solo
# Linux/Mac:
celery -A dagenthub worker -l info -Q celery
```

**注意**: Celery Worker 必须常驻运行，关闭后异步任务会卡住。

### 终端 3: 启动 LM Studio (可选)

1. 打开 LM Studio 软件
2. 搜索并下载模型：
   - 有独显: `meta-llama-3.1-8b-instruct`
   - 无独显: `TinyLlama-1.1B-Chat-v1.0-GGUF`
3. 启动本地服务器

### 终端 4: 启动 Django 后端服务器

```bash
# 确保在 DjangoProject 目录下，且虚拟环境已激活
cd DjangoProject

# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# 启动 Django 开发服务器
python manage.py runserver
```

后端 API 将在 `http://localhost:8000` 运行。

### 终端 5: 启动 Vue 前端开发服务器

```bash
# 进入前端目录
cd frontend

# 启动开发服务器
npm run dev
```

前端页面将在 `http://localhost:3000` 运行。

## 访问应用

打开浏览器访问: **http://localhost:3000**

## 开发调试

### 前端调试（后端未实现接口时）

在浏览器控制台执行以下代码，可以模拟登录状态：

```javascript
localStorage.setItem('auth_token', 'dev-token')
localStorage.setItem('auth_user', JSON.stringify({ id: 1, username: 'dev' }))
location.reload()
```

这样可以进入仪表盘、表单和详情页验证 UI，但 API 调用会报错。

### 构建生产版本

```bash
# 进入前端目录
cd frontend

# 构建
npm run build

# 构建产物在 dist/ 目录
```

## 常见问题

### 1. Celery Worker 启动失败
- 确保 Redis 已启动
- Windows 用户必须使用 `--pool=solo` 参数

### 2. 前端无法连接后端
- 检查 Django 服务器是否在 8000 端口运行
- 检查 `vite.config.ts` 中的代理配置

### 3. WebSocket 连接失败
- 确保 Redis 已启动
- 检查 `settings.py` 中的 `CHANNEL_LAYERS` 配置

### 4. 数据库迁移错误
- 删除 `db.sqlite3` 文件（注意备份数据）
- 重新执行 `makemigrations` 和 `migrate`

## 项目配置说明

- **后端 API**: `http://localhost:8000/api/`
- **WebSocket**: `ws://localhost:8000/ws/`
- **前端代理**: Vite 会自动代理 `/api` 和 `/ws` 到后端
- **CORS**: 开发环境已配置为允许所有来源

## 停止服务

按 `Ctrl+C` 停止各个服务，建议按以下顺序停止：
1. 前端开发服务器
2. Django 服务器
3. Celery Worker
4. Redis (可选，其他服务依赖它)

